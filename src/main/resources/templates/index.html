<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>TodoApp</title>
	<style>
		body {
			text-align: center;
			color: #efefef;
			background-color: #2f2f2f;
			height: 100vh;
			font-size: 16px;
			line-height: 1.6;
			margin: 0;
		}

		.content-wrapper {
			opacity: 0;
			animation-name: anim-main;
			animation-duration: 4s;
			animation-fill-mode: forwards;
		}

		@keyframes anim-main {
			0% {
				opacity: 0;
			}
			100% {
				opacity: 1;
			}
		}

		.back-image {
			position: fixed;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			z-index: -1;
			opacity: 0.5;
		}

		h1, h3 {
			margin-top: 0;
			text-decoration: underline;
		}

		main {
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		section {
			width: 50%;
			padding: 1.2em;
			border-radius: 1em;
			border: lime solid 0.5em;
		}

		main > :not(:first-child) {
			margin-top: 2em;
		}

		section > :not(:first-child) {
			margin-top: 0.5em;
		}

		.task {
			scale: 1.25;
		}


		table {
			border-collapse: collapse;
			border-spacing: 0;
			user-select: none;
			width: 80%;
			margin: 0 auto;
		}
		
		td {
			font-size: 2em;
			padding: 0.25em;
			border: solid;
		}

		th {
			border: solid;
			padding: 0.5em 0;
		}

		td, th {
			border-color: white;
		}

		th:first-child, td:first-child {
			color: red;
		}

		th:last-child, td:last-child {
			color: aqua;
		}

		td.is-disabled {
			color: #6f6f6f;
		}
	</style>
</head>
<body>
	<!-- <img th:src="@{/img/meshitero.jpg}" class="back-image"> -->
	<img th:src="@{/img/forest.jpg}" alt="森" class="back-image">
	<div class="content-wrapper">
		<header>
			<h1>TodoList</h1>
		</header>
		<main>
			<section>
				<h3>マイタスク</h3>
				<form method="post" class="task undoneList" th:action="@{/update}" th:each="todo : ${todos}">
					<input type="checkbox" name="done_flg" value="1" />
					<input type="hidden" name="id" th:value="${todo.id}" />
					<input type="text" name="title" th:value="${todo.title}" />
					<input type="datetime-local" name="time_limit" th:value="${todo.time_limit}" />
					<input type="submit" value="更新"/>
				</form>
			</section>
			
			<section>
				<h3>完了済み</h3>
				<form method="post" class="task" id="doneTodoList" th:action="@{/update}" th:each="todo : ${doneTodos}">
					<input type="checkbox" name="done_flg" value="1" />
					<input type="hidden" name="id" th:value="${todo.id}" />
					<input type="text" name="title" th:value="${todo.title}" style="text-decoration: line-through;"/>
					<input type="datetime-local" name="time_limit" th:value="${todo.time_limit}" />
					<input type="submit" value="更新"/>
				</form>
				<form method="post" class="task" th:action="@{/delete}">
					<input type="submit" value="完了済みを削除" />
				</form>
			</section>
			
			<section>
				<h3>新しいタスクを追加</h3>
				<form method="post" class="task" th:action="@{/add}">
					<input type="text" name="title" />
					<input type="datetime-local" name="time_limit" />
					<input type="submit" name="追加" value="追加"/>
				</form>
			</section>

			<section>
				<button id="setCalenderPrevious">先月</button>
				<button id="setCalenderNext">翌月</button>
				<div id="dynamicCalender"></div>
			</section>
		</main>
	</div>

	<script>
		const INPUT_VALUE_DATE_REGEX = /(\d{4})-(\d{2})-(\d{2})T.*/;

		function createCalenderHtml(date) {
			const WEEK_STR_ARR = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
			//一週間は何日あるかの定数
			const WEEK_COUNT = 7;
			//一か月に何週間あるかの定数
			const MONTH_WEEKS_COUNT = 6;

			const currentYear = date.getFullYear();
			const currentMonth = date.getMonth() + 1;

			//月の最初の日付
			const monthStartDate = new Date(currentYear, currentMonth - 1, 1);
			//月の最後の日付
			//(currentMonth + 1)月の0日目 => currentMonthの最終日
			const monthEndDay = new Date(currentYear, currentMonth, 0);

			//前月の最後の日付
			//(currentMonth)月の0日目 => 前月の最終日
			const lastMonthEndDate = new Date(currentYear, currentMonth - 1, 0);

			const endDayCount = monthEndDay.getDate();
			const monthStartDay = monthStartDate.getDay();

			let dayCount = 1;
			let calenderHtml = "";

			calenderHtml += `<h1>${currentYear}/${currentMonth}</h1>`;
			calenderHtml += "<table>";

			//Sun. ~ Sat. のやつ
			calenderHtml += "<tr>";
			for (let i = 0; i < WEEK_COUNT; i++) {
				calenderHtml += `<th>${WEEK_STR_ARR[i]}.</th>`;
			}
			calenderHtml += "</tr>";


			for (let i = 0; i < MONTH_WEEKS_COUNT; i++) {
				calenderHtml += "<tr>";

				for (let j = 0; j < WEEK_COUNT; j++) {
					if (i === 0 && j < monthStartDay) {
						//月の最初の週かつ、月の始まりの曜日の前なら
						let num = lastMonthEndDate.getDate() - monthStartDay + j + 1;
						calenderHtml += `<td class="is-disabled">${num}</td>`;
					} else if (dayCount > endDayCount) {
						//月の
						let num = dayCount - endDayCount;
						calenderHtml += `<td class="is-disabled">${num}</td>`;
						dayCount++;
					} else {
						calenderHtml += `<td>${dayCount}</td>`;
						dayCount++;
					}
				}

				calenderHtml += "</tr>";
			}
			return calenderHtml;
		}

		function setCalenderHtml(date) {
			const calenderHtml = createCalenderHtml(date);

			document.getElementById("dynamicCalender").innerHTML = calenderHtml;
		}

		function markCalender() {
			//document.getElementsByClassName("undoneList")[1].querySelector("input[name=time_limit]").value
		}


		class Calender {
			constructor() {
				const currentDate = this.currentDate = new Date();
				this.monthOffset = 0;
				setCalenderHtml(currentDate);
			}

			setCalenderLastMonth() {
				this.monthOffset--;
				const year = this.currentDate.getFullYear();
				const month = this.currentDate.getMonth();
				setCalenderHtml(new Date(year, month + this.monthOffset));
			}

			setCalenderNextMonth() {
				this.monthOffset++;
				const year = this.currentDate.getFullYear();
				const month = this.currentDate.getMonth();
				setCalenderHtml(new Date(year, month + this.monthOffset));
			}
		}
		const calender = new Calender();

		document.getElementById("setCalenderPrevious").addEventListener("click", (ev) => {
			calender.setCalenderLastMonth();
		});
		document.getElementById("setCalenderNext").addEventListener("click", (ev) => {
			calender.setCalenderNextMonth();
		});

	</script>
</body>
</html>
