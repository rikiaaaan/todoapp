<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>TodoApp SAMPLE FILE</title>
	<style>
		/*! destyle.css v4.0.1 | MIT License | https://github.com/nicolas-cusan/destyle.min.css */
		*,::before,::after{box-sizing:border-box;border-style:solid;border-width:0;min-width:0}html{line-height:1.15;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}body{margin:0}main{display:block}p,table,blockquote,address,pre,iframe,form,figure,dl{margin:0}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;margin:0}ul,ol{margin:0;padding:0;list-style:none}dt{font-weight:700}dd{margin-left:0}hr{box-sizing:content-box;height:0;overflow:visible;border-top-width:1px;margin:0;clear:both;color:inherit}pre{font-family:monospace,monospace;font-size:inherit}address{font-style:inherit}a{background-color:transparent;text-decoration:none;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:inherit}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}svg,img,embed,object,iframe{vertical-align:bottom}button,input,optgroup,select,textarea{-webkit-appearance:none;appearance:none;vertical-align:middle;color:inherit;font:inherit;background:transparent;padding:0;margin:0;border-radius:0;text-align:inherit;text-transform:inherit}button,[type="button"],[type="reset"],[type="submit"]{cursor:pointer}button:disabled,[type="button"]:disabled,[type="reset"]:disabled,[type="submit"]:disabled{cursor:default}:-moz-focusring{outline:auto}select:disabled{opacity:inherit}option{padding:0}fieldset{margin:0;padding:0;min-width:0}legend{padding:0}progress{vertical-align:baseline}textarea{overflow:auto}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{outline-offset:-2px}[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}[type="number"]{-moz-appearance:textfield}label[for]{cursor:pointer}details{display:block}summary{display:list-item}[contenteditable]:focus{outline:auto}table{border-color:inherit;border-collapse:collapse}caption{text-align:left}td,th{vertical-align:top;padding:0}th{text-align:left;font-weight:700}
	</style>
	<style>
		body {
			text-align: center;
			color: #efefef;
			background-color: #1f1f1f;
			height: 100vh;
			font-size: 16px;
			line-height: 1.6;
			margin: 0;
			user-select: none;
		}

		.content-wrapper {
			opacity: 0;
			animation-name: anim-main;
			animation-duration: 3s;
			animation-fill-mode: forwards;
		}

		@keyframes anim-main {
			0% {
				opacity: 0;
			}
			100% {
				opacity: 1;
			}
		}

		.hidden {
			display: none;
		}

		.back-image {
			position: fixed;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			z-index: -1;
			opacity: 0.5;
		}

		header {
			height: 3em;
			overflow: hidden;
		}

		h1 {
			font-size: 2em;
		}

		h3 {
			font-size: 1.2em;
		}

		h1, h3 {
			text-decoration: underline;
		}

		main {
			padding: 1.25em 0;
			display: flex;
			justify-content: space-evenly;
			align-items: center;
		}

		section {
			padding: 1.2em;
			border-radius: 1em;
			border: lime solid 0.5em;
		}

		section > :not(:first-child),
		.task-list > :not(:first-child) {
			margin-top: 0.5em;
		}

		.todo-container {
			width: 40%;
		}

		.todo-container > div {
			transition-property: all;
			transition-duration: 1s;
		}

		.todo-container > section {
			width: 100%;
		}

		.todo-container > :not(:first-child) {
			margin-top: 2em;
		}

		.container-controller {
			height: 3em;
			border: 0.25em solid lime;
			border-radius: 1.2em;
		}

		.container-wrapper {
			height: 40em;
			overflow-x: hidden;
			overflow-y: auto;
			position: relative;
		}

		.hidden-container-wrapper {
			margin-top: 0em !important;
			height: 0em !important;
		}

		.list-container {
			height: 100%;
		}

		.hidden-list-container {
			height: 0px;
		}

		.task-list {
			height: calc(100% - 6.5em);
			padding: 1.25em;
			overflow-x: hidden;
			overflow-y: auto;
		}

		.list-container-bottom-button {
			width: 100%;
			height: 3em;
			font-size: 1.25em;
			border: 1px solid lime;
			border-radius: 5em;
			padding: 0.5em;
		}

		.delete-task-button:hover {
			background-color: #00ff002f;
		}

		.task {
			font-size: 1.25em;
			border: 1px solid lime;
			border-radius: 5em;
			padding: 0.5em 1em;
			transition-property: all;
			transition-duration: 0.5s;
		}

		.task:hover {
			background-color: #00ff007f;
		}

		.task-title {
			background-color: #efefefaf;
			border-radius: 1em;
			color: #1f1f1f;
		}

		.task-not-found-message {
			font-size: 1.5em;
		}

		.add-task-container {
			height: 8em;
			margin-top: 2em;
		}

		.keikoku {
			position: fixed;
			left: 0;
			bottom: 0;
			text-decoration: underline;
			font-weight: bolder;
		}

		.calender-sticky-parent {
			width: 40%;
			height: 100%;
		}

		.calender-container {
			position: sticky;
			top: 5em;
			overflow-x: auto;
			overflow-y: hidden;
		}

		.calender-controller-button-container {
			display: flex;
			justify-content: space-around;
			align-items: center;
			height: 2.5em;
		}

		table {
			border-collapse: collapse;
			border-spacing: 0;
			width: 80%;
			margin: 0 auto;
		}

		td {
			font-size: 2em;
			padding: 0.25em;
			border: solid;
		}

		th {
			border: solid;
			padding: 0.5em 0;
			text-align: center;
		}

		td, th {
			border-color: white;
		}

		th:first-child, td:first-child {
			color: red;
		}

		th:last-child, td:last-child {
			color: aqua;
		}

		td.is-disabled {
			color: #6f6f6f;
		}

		.popup-container {
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}

		.popup-back {
			position: fixed;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			z-index: 10;
			background-color: #000000bf;
		}

		.todo-add-popup-container {
			position: relative;
			left: 0;
			top: 0;
			width: 40em;
			height: 50em;
			margin: 2em auto 0 auto;
			z-index: 10;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.popup-title {
			font-size: 2em;
			text-decoration: underline;
			background-color: #003300;
			padding: 0.45em 2em;
			border: 0.2em solid lime;
			border-radius: 0.5em;
		}

		.popup-form {
			width: 40rem;
			height: 40em;
			background-color: #003300;
			border: 0.5em solid lime;
			border-radius: 5%;
			margin-top: 3em;
			padding: 1.5rem;
			font-size: 1.25em;

			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.popup-form input[type=text],
		.popup-form input[type=datetime-local] {
			background-color: #efefef;
			color: #1f1f1f;
			padding: 0.5rem 0;
			font-size: 1.5em;
		}

		.popup-form-item {
			width: 100%;
			display: flex;
			flex-direction: column;
		}

		.popup-form > div:not(:first-child) {
			margin-top: 1.5em;
		}

		.popup-form label {
			text-decoration: underline;
		}

		.popup-form input[type=checkbox] {
			color: white;
			padding: 1.5rem;
			border-radius: 50px;
			width: 100%;
		}

		.popup-form input[type=checkbox]:not(:checked) {
			background-color: #ff00007f;
		}

		.popup-form input[type=checkbox]:checked {
			background-color: #00ff007f;
		}

		.popup-form input[type=checkbox]:not(:checked)::before {
			content: "未完了...";
			font-size: 1.25em;
		} 

		.popup-form input[type=checkbox]:checked::before {
			content: "完了!!!";
			font-size: 1.25em;
		} 

		.popup-form input[type=submit] {
			width: 100%;
			padding: 1rem;
			border: 1px solid lime;
			border-radius: 2em;
			font-size: 1.2em;
		}

		/* hover時に動いたり色が変わったりするスゲーやつ */
		.animation-button-container {
			display: flex;
			justify-content: space-around;
			overflow: hidden;
		}

		.animation-button-container > button {
			height: 100%;
			width: 40%;
			padding: 0 1em;
			background-color: #0000007f;
			transition-property: all;
			transition-duration: 0.5s;
		}

		.animation-button-container > button:hover {
			background-color: #00ff007f;
			width: 50%;
		}

	</style>
</head>
<body>
	<!-- <img th:src="@{/img/meshitero.jpg}" class="back-image"> -->
	<img src="../static/img/forest.jpg" alt="森" class="back-image">
	<div class="content-wrapper">

		<header>
			<h1>FetCH₂() TodoList</h1>
		</header>

		<main>

			<div class="hidden">
				<!-- 実際にth:eachを使ってtaskが入るところ -->
				<ul id="actualUndoneList">
					<form method="post" class="task" action="@{/update}">
						<input type="checkbox" name="done_flg" value="0" />
						<input type="hidden" name="id" value="1" />
						<input type="text" name="title" value="aiueo" />
						<input type="datetime-local" name="time_limit" value="2024-07-10T10:00" />
						<input type="submit" value="更新"/>
					</form>
					<form method="post" class="task" action="@{/update}">
						<input type="checkbox" name="done_flg" value="0" />
						<input type="hidden" name="id" value="56" />
						<input type="text" name="title" value="kakikukeko" />
						<input type="datetime-local" name="time_limit" value="2024-07-14T10:00" />
						<input type="submit" value="更新"/>
					</form>
					<form method="post" class="task" action="@{/update}">
						<input type="checkbox" name="done_flg" value="0" />
						<input type="hidden" name="id" value="72" />
						<input type="text" name="title" value="sashisuseso" />
						<input type="datetime-local" name="time_limit" value="2024-07-21T10:00" />
						<input type="submit" value="更新"/>
					</form>
					<form method="post" class="task" action="@{/update}">
						<input type="checkbox" name="done_flg" value="0" />
						<input type="hidden" name="id" value="81" />
						<input type="text" name="title" value="tachitsuteto" />
						<input type="datetime-local" name="time_limit" value="2024-07-23T10:00" />
						<input type="submit" value="更新"/>
					</form>
					<form method="post" class="task" action="@{/update}">
						<input type="checkbox" name="done_flg" value="0" />
						<input type="hidden" name="id" value="2" />
						<input type="text" name="title" value="sasisuseso" />
						<input type="datetime-local" name="time_limit" value="2022-07-10T10:00" />
						<input type="submit" value="更新"/>
					</form>
					<form method="post" class="task" action="@{/update}">
						<input type="checkbox" name="done_flg" value="0" />
						<input type="hidden" name="id" value="3" />
						<input type="text" name="title" value="逆立ちで世界一周旅行をする" />
						<input type="datetime-local" name="time_limit" value="2024-09-11T20:00" />
						<input type="submit" value="更新"/>
					</form>
					<form method="post" class="task" action="@{/update}">
						<input type="checkbox" name="done_flg" value="0" />
						<input type="hidden" name="id" value="12" />
						<input type="text" name="title" value="昼食を食べる" />
						<input type="datetime-local" name="time_limit" value="2024-06-14T10:00" />
						<input type="submit" value="更新"/>
					</form>
				</ul>
				<!-- 実際にth:eachを使ってtaskが入るところ -->
				<ul id="actualDoneList">
					<li method="post" class="task" th:action="@{/update}" th:each="todo : ${doneTodos}">
						<input type="checkbox" name="done_flg" value="1" />
						<input type="hidden" name="id" value="5" />
						<input type="text" name="title" value="kakikukeko" style="text-decoration: line-through;"/>
						<input type="datetime-local" name="time_limit" value="2024-08-10T10:10" />
						<input type="submit" value="更新"/>
					</li>
					<li method="post" class="task" th:action="@{/update}" th:each="todo : ${doneTodos}">
						<input type="checkbox" name="done_flg" value="1" />
						<input type="hidden" name="id" value="9" />
						<input type="text" name="title" value="aaaaaaaaaaaaaaaaaaaaa" style="text-decoration: line-through;"/>
						<input type="datetime-local" name="time_limit" value="2024-07-20T10:10" />
						<input type="submit" value="更新"/>
					</li>
					<li method="post" class="task" th:action="@{/update}" th:each="todo : ${doneTodos}">
						<input type="checkbox" name="done_flg" value="1" />
						<input type="hidden" name="id" value="6" />
						<input type="text" name="title" value="aaaaaaaaaaaaaaaaaaaaa" style="text-decoration: line-through;"/>
						<input type="datetime-local" name="time_limit" value="2024-07-27T10:10" />
						<input type="submit" value="更新"/>
					</li>
					<li method="post" class="task" th:action="@{/update}" th:each="todo : ${doneTodos}">
						<input type="checkbox" name="done_flg" value="1" />
						<input type="hidden" name="id" value="7" />
						<input type="text" name="title" value="朝食を食べる" style="text-decoration: line-through;"/>
						<input type="datetime-local" name="time_limit" value="2024-08-10T19:12" />
						<input type="submit" value="更新"/>
					</li>
				</ul>
			</div>

			<div class="todo-container">

				<div class="container-controller animation-button-container">
					<button id="showUndoneList">未完了のタスクを表示</button>
					<button id="showDoneList">完了済みのタスクを表示</button>
				</div>

				<div class="container-wrapper" id="undoneWrapper">
					<section class="list-container">
						<h3><span class="js-calender-date"></span>の未完了のマイタスク</h3>
						<ul class="task-list" id="undoneListDisplayer">

						</ul>
						<button class="list-container-bottom-button" id="addTaskButton">タスクを追加</button>
					</section>
				</div>

				<div class="container-wrapper" id="doneWrapper">
					<section class="list-container">
						<h3><span class="js-calender-date"></span>の完了済みタスク</h3>
						<ul class="task-list" id="doneListDisplayer">

						</ul>
						<form method="post" th:action="@{/delete}">
							<input type="submit" class="list-container-bottom-button" value="完了済みを削除" />
						</form>
					</section>
				</div>

			</div>

			<div class="calender-sticky-parent">
				<section class="calender-container">
					<div class="calender-controller-button-container animation-button-container">
						<button id="setCalenderLastMonth">先月</button>
						<button id="setCalenderNextMonth">翌月</button>
					</div>
					<div id="dynamicCalender"></div>
				</section>
			</div>

		</main>

		<div class="popup-container" id="popupContainer">
			<div class="popup-back" id="popupBack"></div>
			<div class="settings-container" id="settingsPopup">
				<div class="settings-item"></div>
				<div class="settings-item"></div>
			</div>
			<div class="todo-add-popup-container" id="todoPopup">
				<h2 class="popup-title" id="popupTitle">タスクを追加</h2>
				<form action="" method="post" class="popup-form" id="popupForm">
					<div>
						<h3>タスクの名前</h3>
						<input type="text" name="title" placeholder="タスクの名前" required />
					</div>

					<div>
						<label for="done_flg">タスクが終わったかどうか</label>
						<br>
						<input type="checkbox" name="done_flg" id="done_flg"/>
					</div>

					<div>
						<h3>タスクをいつまでに終わらせるか</h3>
						<small>カレンダーのアイコンをクリックして詳細に編集します</small>
						<input type="datetime-local" name="time_limit" required />
					</div>

					<div>
						<input type="submit" value="更新">
					</div>

					<input type="hidden" name="id" />
				</form>
			</div>
		</div>
	</div>

	<p class="keikoku">これはサンプルファイルです。本番用ではありません</p>

	<script>

		//childrenとかgetElementsByClassNameとかで返ってくるHTML要素の配列の子要素ごとに実行する関数
		HTMLCollection.prototype.forEach = function(fn) {
			for (let i = 0, l = this.length; i < l; i++) {
				fn(this[i]);
			}
		};

		// 【見てごらん】datetime-localのvalueから年、月、日、時間、分とかをそれぞれ個別に取得できる正規表現の強点
		const DATETIME_LOCAL_REGEX = /((\d{4})-((?:0[1-9])|(?:1[0-2]))-((?:0[1-9])|(?:[12]\d)|(?:3[01])))(?:T((?:[01]\d)|(?:2[0-3])):((?:[0-5]\d)))?/;

		function zeroPadding(n) {
			return (n < 10 ? "0" : "") + n;
		}

		// 引数dateの月のカレンダーのHTMLの生成する関数
		function createCalenderHtml(date) {
			const WEEK_STR_ARR = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
			//一週間は何日あるかの定数
			const WEEK_COUNT = 7;
			//一か月に何週間あるかの定数
			const MONTH_WEEKS_COUNT = 6;

			const currentYear = date.getFullYear();
			const currentMonth = date.getMonth() + 1;

			//月の最初の日付
			const monthStartDate = new Date(currentYear, currentMonth - 1, 1);
			//月の最後の日付
			//(currentMonth + 1)月の0日目 => currentMonthの最終日
			const monthEndDay = new Date(currentYear, currentMonth, 0);

			//前月の最後の日付
			//(currentMonth)月の0日目 => 前月の最終日
			const lastMonthEndDate = new Date(currentYear, currentMonth - 1, 0);

			const endDayCount = monthEndDay.getDate();
			const monthStartDay = monthStartDate.getDay();

			let dayCount = 1;
			let calenderHtml = "";

			calenderHtml += `<h1>${currentYear}/${currentMonth}</h1>`;
			calenderHtml += "<table>";

			//Sun. ~ Sat. のやつ
			calenderHtml += "<tr>";
			for (let i = 0; i < WEEK_COUNT; i++) {
				calenderHtml += `<th>${WEEK_STR_ARR[i]}.</th>`;
			}
			calenderHtml += "</tr>";


			for (let i = 0; i < MONTH_WEEKS_COUNT; i++) {
				calenderHtml += "<tr>";

				for (let j = 0; j < WEEK_COUNT; j++) {
					if (i === 0 && j < monthStartDay) {
						//月の最初の週かつ、月の始まりの曜日の前なら
						let num = lastMonthEndDate.getDate() - monthStartDay + j + 1;
						calenderHtml += `<td class="is-disabled">${num}</td>`;
					} else if (dayCount > endDayCount) {
						//月の
						let num = dayCount - endDayCount;
						calenderHtml += `<td class="is-disabled">${num}</td>`;
						dayCount++;
					} else {
						calenderHtml += `<td data-date="${currentYear}-${zeroPadding(currentMonth)}-${zeroPadding(dayCount)}">${dayCount}</td>`;
						dayCount++;
					}
				}

				calenderHtml += "</tr>";
			}
			return calenderHtml;
		}

		// calenderがボタンが押されたなどして更新されたときに実行される関数
		function onUpdateCalender() {
			const undoneList = document.getElementById("undoneList");

			const calenderDate = calenderController.getCurrentDate();

			// ******** めっちゃ重要ポイント **********
			// UndoneListよりも先にDoneListを組み立てる（？）ことによりUndoneListのカレンダーの色付けを優先的にできる
			// **************************************
			buildDoneTaskList(calenderDate);
			buildUndoneTaskList(calenderDate);

			document.getElementsByClassName("js-calender-date").forEach((e) => {
				e.innerText = `${calenderDate.getFullYear()}/${calenderDate.getMonth() + 1}`;
			});
		}

		// undoneList, doneListのtaskのdatetime-localの値を読み取り、calenderにそれぞれ色をつける関数
		// dateStr: "YYYY-MM-DD"
		// markType: 0: Undone, 1: Done
		function markCalender(dateStr, markType) {
			const calenderDate = document.getElementById("dynamicCalender").querySelector(`td[data-date='${dateStr}']`);

			if (calenderDate) {
				switch (markType) {
					//Undone
					case 0: {
						calenderDate.style.backgroundColor = "#ee00007f";
						break;
					}

					//Done
					case 1: {
						calenderDate.style.backgroundColor = "#00ff007f";
						break;
					}

					default: break;
				}
			}
		}

		// actualUndoneListからundoneTaskListを組み立てる関数
		function buildUndoneTaskList(date) {
			const actualUndoneList = document.getElementById("actualUndoneList");
			const undoneListDisplayer = document.getElementById("undoneListDisplayer");

			let undoneListHtml = "";
			
			actualUndoneList.children.forEach((child) => {
				const taskName = child.querySelector("input[name=title]").value;
				const timeLimit = child.querySelector("input[name=time_limit]").value;
				const doneFlg = child.querySelector("input[name=done_flg]").value;
				const taskId = child.querySelector("input[name=id]").value;
				
				const [matched, matchedDate, year, month, day, hour, min] = DATETIME_LOCAL_REGEX.exec(timeLimit).map((e) => {
					return /^\d+$/.test(e) ? Number.parseInt(e) : e;
				});

				if (year === date.getFullYear() && month === (date.getMonth() + 1)) {
					undoneListHtml += `<li class="task" data-id="${taskId}" data-doneFlg="${doneFlg}" data-fullTimeLimit="${matched}">`;
					undoneListHtml += `<p class="task-title">${taskName || "タイトル未設定"}</p>`;
					undoneListHtml += `<p class="task-time-limit">Time Limit: ${zeroPadding(day)}日${zeroPadding(hour)}時${zeroPadding(min)}分`;
					undoneListHtml += `</li>`;

					// matchedDateでundoneでカラー染める（？）
					markCalender(matchedDate, 0);
				}
			});

			if (undoneListHtml === "") {
				undoneListHtml= `<p class="task-not-found-message">現在タスクは登録されていません<br>今月は自由です！</p>`;
			}

			undoneListDisplayer.innerHTML = undoneListHtml;

			undoneListDisplayer.children.forEach((task) => {
				task.addEventListener("click", (ev) => {
					// currenttargetでevent発生元の要素を取得できるらしい
					popupController.showUpdateTaskPopup(ev.currentTarget);
				});
			});
		}

		//actualDoneListからdoneTaskListを組み立てる関数
		function buildDoneTaskList(date) {
			const actualDoneList = document.getElementById("actualDoneList");
			const doneListDisplayer = document.getElementById("doneListDisplayer");

			let doneListHtml = "";
			
			actualDoneList.children.forEach((child) => {
				const taskName = child.querySelector("input[name=title]").value;
				const timeLimit = child.querySelector("input[name=time_limit]").value;
				const doneFlg = child.querySelector("input[name=done_flg]").value;
				const taskId = child.querySelector("input[name=id]").value;
				
				const [matched, matchedDate, year, month, day, hour, min] = DATETIME_LOCAL_REGEX.exec(timeLimit).map((e) => {
					return /^\d+$/.test(e) ? Number.parseInt(e) : e;
				});

				if (year === date.getFullYear() && month === (date.getMonth() + 1)) {
					doneListHtml += `<li class="task" data-id="${taskId}" data-doneFlg="${doneFlg}" data-fullTimeLimit="${matched}">`;
					doneListHtml += `<p class="task-title">${taskName || "タイトル未設定"}</p>`;
					doneListHtml += `<p class="task-time-limit">Time Limit: ${zeroPadding(day)}日${zeroPadding(hour)}時${zeroPadding(min)}分`;
					doneListHtml += `</li>`;

					// matchedDateでdoneでカラー染める（？）
					markCalender(matchedDate, 1);
				}
			});

			if (doneListHtml === "") {
				doneListHtml = `<p class="task-not-found-message">現在完了済みのタスクはありません<br>タスクを達成してから遊びましょう！</p>`;
			}

			doneListDisplayer.innerHTML = doneListHtml;

			doneListDisplayer.children.forEach((task) => {
				task.addEventListener("click", (ev) => {
					// currenttargetでevent発生元の要素を取得できるらしい
					popupController.showUpdateTaskPopup(ev.currentTarget);
				});
			});
		}

		class CalenderController {
			constructor() {
				//変数nowとメンバ変数nowとメンバ変数currentDateを同時に初期化
				const now = this.now = this.currentDate = new Date();
				this.monthOffset = 0;

				document.getElementById("dynamicCalender").innerHTML = createCalenderHtml(now);
			}

			// メンバ変数currentDateをそのまま返す
			getCurrentDate() {
				return this.currentDate;
			}

			// カレンダーを現在の一か月前にセットする
			setCalenderLastMonth() {
				this.monthOffset--;
				const year = this.now.getFullYear();
				const month = this.now.getMonth();
				const currentDate = this.currentDate = new Date(year, month + this.monthOffset);

				document.getElementById("dynamicCalender").innerHTML = createCalenderHtml(currentDate);
			}

			// カレンダーを減在の一か月後にセットする
			setCalenderNextMonth() {
				this.monthOffset++;
				const year = this.now.getFullYear();
				const month = this.now.getMonth();
				const currentDate = this.currentDate = new Date(year, month + this.monthOffset);

				document.getElementById("dynamicCalender").innerHTML = createCalenderHtml(currentDate);
			}
		}

		// DoneListとUndoneListの表示を切り替えるクラス
		class ContainerWrapperController {
			constructor() {
				/*
				0: undoneListが表示されている
				1: doneListが表示されている
				*/
				this.state = 0;

				document.getElementById("doneWrapper").classList.add("hidden-container-wrapper");
			}

			// 未完了のタスクを表示させる
			showUndoneList() {
				if (this.state !== 0) {
					const undoneWrapper = document.getElementById("undoneWrapper");
					const doneWrapper = document.getElementById("doneWrapper");

					if (undoneWrapper && doneWrapper) {
						undoneWrapper.classList.remove("hidden-container-wrapper");
						doneWrapper.classList.add("hidden-container-wrapper");
						this.state = 0;
					}
				} else {
					console.warn("undoneListはすでに表示されています。");
				}
			}

			// 完了済みのタスクを表示させる
			showDoneList() {
				if (this.state !== 1) {
					const undoneWrapper = document.getElementById("undoneWrapper");
					const doneWrapper = document.getElementById("doneWrapper");

					if (undoneWrapper && doneWrapper) {
						undoneWrapper.classList.add("hidden-container-wrapper");
						doneWrapper.classList.remove("hidden-container-wrapper");
						this.state = 1;
					}
				} else {
					console.warn("doneListはすでに表示されています。");
				}
			}
		}

		class PopupController {
			constructor() {
				/*
				0: 何もポップアップされていない
				1: 設定が表示されている
				2: タスク編集が表示されている
				3: タスク追加が表示されている
				*/
				this.state = 0;

				const popupContainer = this.popupContainer = document.getElementById("popupContainer");
				popupContainer.style.display = "none";

				// ポップアップ時の後ろのくろいやつをクリックしたらポップアップを隠すイベントの追加
				let _this = this;
				document.getElementById("popupBack").addEventListener("click", (e) => {
					_this.hidePopup();
				});
			}

			// popupを隠す
			hidePopup() {
				if (this.state !== 0) {
					this.popupContainer.style.display = "none";
					this.state = 0;
				}
			}

			// 設定ポップアップを表示し、stateを1にする
			showSettingsPopup() {
				if (this.state === 0) {
					this.popupContainer.style.display = "block";
					this.state = 1;
				}
			}

			// タスク編集ポップアップを表示し、stateを2にする
			showUpdateTaskPopup(task) {
				if (this.state === 0) {
					if (task instanceof HTMLLIElement && "id" in task.dataset) {
						const popupForm = document.getElementById("popupForm");
						const taskDoneFlg = task.dataset.doneflg;
						const taskId = task.dataset.id;
						const taskTitle = task.getElementsByClassName("task-title")[0].innerHTML;
						const taskTimeLimit = task.dataset.fulltimelimit;

						let popupFormHtml = "";

						popupFormHtml = `
							<input type="hidden" name="id" value="${taskId}">
							<div class="popup-form-item">
								<h3>タスクの名前</h3>
								<input type="text" name="title" placeholder="タスクの名前" value="${taskTitle}" required />
							</div>
							<div class="popup-form-item">
								<label for="done_flg">タスクが終わったかどうか</label>
								<input type="checkbox" name="done_flg" id="done_flg" ${Number.parseInt(taskDoneFlg) === 1 ? "checked" : ""} value="${taskDoneFlg}" id="popupFormDoneFlgCheckbox" onchange="this.value=this.checked?'1':'0'"/>
							</div>

							<div class="popup-form-item">
								<h3>タスクをいつまでに終わらせるか</h3>
								<small>カレンダーのアイコンをクリックして詳細に編集します</small>
								<input type="datetime-local" name="time_limit" value="${taskTimeLimit}" required />
							</div>

							<div class="popup-form-item">
								<input type="submit" value="更新" />
							</div>
						`;

						popupForm.innerHTML = popupFormHtml;

						document.getElementById("popupTitle").innerText = "タスクを編集";
						
						this.popupContainer.style.display = "block";
						this.state = 2;
					}
				}
			}

			// タスク追加ポップアップを表示し、stateを3にする
			showAddTaskPopup() {
				if (this.state === 0) {
					this.popupContainer.style.display = "block";

					document.getElementById("popupForm").innerHTML = `
						<div class="popup-form-item">
							<h3>タスクの名前</h3>
							<input type="text" name="title" placeholder="タスクの名前" required />
						</div>

						<div class="popup-form-item">
							<h3>タスクをいつまでに終わらせるか</h3>
							<small>カレンダーのアイコンをクリックして詳細に編集します</small>
							<input type="datetime-local" name="time_limit" required />
						</div>

						<div class="popup-form-item">
							<input type="submit" value="追加" />
						</div>
					`;

					document.getElementById("popupTitle").innerText = "タスクを追加";

					this.state = 3;
				}
			}
		}

		// それぞれのcontrollerのインスタンスを生成
		const calenderController = new CalenderController();
		const containerWrapperController = new ContainerWrapperController();
		const popupController = new PopupController();

		// それぞれのボタンにcontrollerのメソッドを呼び出すイベントを追加
		document.getElementById("showUndoneList").addEventListener("click", (_e) => {
			containerWrapperController.showUndoneList();
		});
		document.getElementById("showDoneList").addEventListener("click", (_e) => {
			containerWrapperController.showDoneList();
		});

		document.getElementById("addTaskButton").addEventListener("click", (_e) => {
			popupController.showAddTaskPopup();
		});

		document.getElementById("setCalenderLastMonth").addEventListener("click", (_e) => {
			calenderController.setCalenderLastMonth();
			onUpdateCalender();
		});
		document.getElementById("setCalenderNextMonth").addEventListener("click", (_e) => {
			calenderController.setCalenderNextMonth();
			onUpdateCalender();
		});

		onUpdateCalender();
	</script>
</body>
</html>
